<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Plan Assistant CLI Command Builder</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #0d1117;
    --surface: #161b22;
    --surface-2: #1c2129;
    --border: #30363d;
    --text: #e6edf3;
    --text-muted: #8b949e;
    --accent: #58a6ff;
    --accent-dim: rgba(88, 166, 255, 0.15);
    --green: #3fb950;
    --orange: #d29922;
    --red: #f85149;
    --radius: 8px;
    --radius-sm: 6px;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.5;
    min-height: 100vh;
  }

  header {
    padding: 20px 32px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 16px;
  }

  header h1 {
    font-size: 20px;
    font-weight: 600;
    color: var(--text);
  }

  header h1 span {
    color: var(--accent);
  }

  header .badge {
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 12px;
    background: var(--accent-dim);
    color: var(--accent);
    font-weight: 500;
  }

  .layout {
    display: grid;
    grid-template-columns: 380px 1fr;
    min-height: calc(100vh - 65px);
  }

  /* Left Panel */
  .left-panel {
    border-right: 1px solid var(--border);
    padding: 24px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  .section-label {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-muted);
    margin-bottom: 10px;
  }

  /* Presets */
  .presets {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  .preset-btn {
    font-size: 12px;
    padding: 4px 10px;
    border-radius: 16px;
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
  }

  .preset-btn:hover {
    border-color: var(--accent);
    color: var(--accent);
    background: var(--accent-dim);
  }

  /* Command Cards */
  .command-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
  }

  .command-card {
    padding: 12px;
    border-radius: var(--radius);
    border: 1px solid var(--border);
    background: var(--surface);
    cursor: pointer;
    transition: all 0.15s;
  }

  .command-card:hover {
    border-color: var(--text-muted);
  }

  .command-card.active {
    border-color: var(--accent);
    background: var(--accent-dim);
  }

  .command-card .cmd-name {
    font-size: 14px;
    font-weight: 600;
    color: var(--accent);
    margin-bottom: 2px;
    font-family: 'SF Mono', SFMono-Regular, Consolas, 'Liberation Mono', Menlo, monospace;
  }

  .command-card.active .cmd-name {
    color: var(--accent);
  }

  .command-card .cmd-desc {
    font-size: 11px;
    color: var(--text-muted);
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Flags Section */
  .flags-section {
    display: flex;
    flex-direction: column;
    gap: 14px;
  }

  .flag-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
  }

  .flag-label {
    font-size: 12px;
    color: var(--text-muted);
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .flag-label code {
    font-family: 'SF Mono', SFMono-Regular, Consolas, 'Liberation Mono', Menlo, monospace;
    color: var(--orange);
    font-size: 12px;
  }

  .flag-hint {
    font-size: 11px;
    color: var(--text-muted);
    opacity: 0.7;
    margin-top: 1px;
  }

  input[type="text"],
  input[type="number"] {
    width: 100%;
    padding: 8px 12px;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    background: var(--surface-2);
    color: var(--text);
    font-size: 13px;
    font-family: 'SF Mono', SFMono-Regular, Consolas, 'Liberation Mono', Menlo, monospace;
    outline: none;
    transition: border-color 0.15s;
  }

  input[type="text"]:focus,
  input[type="number"]:focus {
    border-color: var(--accent);
  }

  input[type="text"]::placeholder,
  input[type="number"]::placeholder {
    color: var(--text-muted);
    opacity: 0.5;
  }

  input[type="text"]:disabled,
  input[type="number"]:disabled {
    opacity: 0.35;
    cursor: not-allowed;
  }

  /* Toggle Switch */
  .toggle-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 6px 0;
  }

  .toggle-row .left {
    display: flex;
    flex-direction: column;
    gap: 1px;
  }

  .toggle-switch {
    position: relative;
    width: 36px;
    height: 20px;
    flex-shrink: 0;
  }

  .toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .toggle-slider {
    position: absolute;
    cursor: pointer;
    inset: 0;
    background: var(--border);
    border-radius: 10px;
    transition: 0.2s;
  }

  .toggle-slider::before {
    content: '';
    position: absolute;
    height: 14px;
    width: 14px;
    left: 3px;
    bottom: 3px;
    background: var(--text-muted);
    border-radius: 50%;
    transition: 0.2s;
  }

  .toggle-switch input:checked + .toggle-slider {
    background: var(--accent);
  }

  .toggle-switch input:checked + .toggle-slider::before {
    transform: translateX(16px);
    background: #fff;
  }

  .toggle-switch input:disabled + .toggle-slider {
    opacity: 0.35;
    cursor: not-allowed;
  }

  /* Right Panel */
  .right-panel {
    padding: 24px 32px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  .preview-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
  }

  .preview-card-header {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .preview-card-header h3 {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-muted);
  }

  .preview-card-body {
    padding: 16px;
  }

  /* Command Preview */
  .command-preview {
    font-family: 'SF Mono', SFMono-Regular, Consolas, 'Liberation Mono', Menlo, monospace;
    font-size: 14px;
    line-height: 1.6;
    word-break: break-all;
    white-space: pre-wrap;
  }

  .command-preview .tok-bin { color: var(--text); }
  .command-preview .tok-cmd { color: var(--accent); font-weight: 600; }
  .command-preview .tok-pos { color: var(--green); }
  .command-preview .tok-flag { color: var(--orange); }
  .command-preview .tok-val { color: var(--text); }

  /* Description */
  .description-text {
    font-size: 14px;
    line-height: 1.6;
    color: var(--text-muted);
  }

  /* Expected Output */
  .expected-output {
    font-family: 'SF Mono', SFMono-Regular, Consolas, 'Liberation Mono', Menlo, monospace;
    font-size: 13px;
    line-height: 1.5;
    color: var(--text-muted);
    white-space: pre-wrap;
    word-break: break-all;
  }

  /* Prompt Output */
  .prompt-text {
    font-size: 14px;
    line-height: 1.7;
    color: var(--text);
    cursor: text;
  }

  .prompt-text:focus {
    outline: 1px solid #58a6ff;
    outline-offset: 2px;
  }

  .prompt-editable-hint {
    font-size: 11px;
    color: #8b949e;
    margin-top: 4px;
  }

  .prompt-text code {
    font-family: 'SF Mono', SFMono-Regular, Consolas, 'Liberation Mono', Menlo, monospace;
    background: var(--surface-2);
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 13px;
    color: var(--accent);
    word-break: break-all;
  }

  /* Copy Button */
  .copy-btn {
    font-size: 12px;
    padding: 4px 12px;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    background: var(--surface-2);
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.15s;
    display: flex;
    align-items: center;
    gap: 5px;
    white-space: nowrap;
  }

  .copy-btn:hover {
    border-color: var(--accent);
    color: var(--accent);
  }

  .copy-btn.copied {
    border-color: var(--green);
    color: var(--green);
  }

  .copy-btn svg {
    width: 14px;
    height: 14px;
  }

  /* Responsive */
  @media (max-width: 900px) {
    .layout {
      grid-template-columns: 1fr;
    }
    .left-panel {
      border-right: none;
      border-bottom: 1px solid var(--border);
    }
  }
</style>
</head>
<body>

<header>
  <h1><span>plan-assistant</span> CLI Command Builder</h1>
  <span class="badge">Playground</span>
</header>

<div class="layout">
  <!-- Left Panel -->
  <div class="left-panel">
    <!-- Presets -->
    <div>
      <div class="section-label">Presets</div>
      <div class="presets" id="presets"></div>
    </div>

    <!-- Command Selector -->
    <div>
      <div class="section-label">Command</div>
      <div class="command-grid" id="command-grid"></div>
    </div>

    <!-- Session / File Input (contextual) -->
    <div id="positional-section" style="display:none">
      <div class="flag-group">
        <label class="flag-label" id="positional-label">Session ID or markdown file path</label>
        <input type="text" id="positional-input" placeholder="./plans/my-plan.md">
      </div>
    </div>

    <!-- Flags -->
    <div id="flags-container">
      <div class="section-label">Flags</div>
      <div class="flags-section" id="flags-section"></div>
    </div>
  </div>

  <!-- Right Panel -->
  <div class="right-panel">
    <!-- Command Preview -->
    <div class="preview-card">
      <div class="preview-card-header">
        <h3>Command</h3>
        <button class="copy-btn" id="copy-cmd-btn" onclick="copyCommand()">
          <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"/></svg>
          Copy
        </button>
      </div>
      <div class="preview-card-body">
        <div class="command-preview" id="command-preview"></div>
      </div>
    </div>

    <!-- Description -->
    <div class="preview-card">
      <div class="preview-card-header">
        <h3>Description</h3>
      </div>
      <div class="preview-card-body">
        <div class="description-text" id="description-text"></div>
      </div>
    </div>

    <!-- Expected Output -->
    <div class="preview-card">
      <div class="preview-card-header">
        <h3>Expected Output</h3>
      </div>
      <div class="preview-card-body">
        <div class="expected-output" id="expected-output"></div>
      </div>
    </div>

    <!-- Prompt -->
    <div class="preview-card">
      <div class="preview-card-header">
        <h3>Prompt</h3>
        <button class="copy-btn" id="copy-prompt-btn" onclick="copyPrompt()">
          <svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"/></svg>
          Copy
        </button>
      </div>
      <div class="preview-card-body">
        <div class="prompt-text" id="prompt-text" contenteditable="true"></div>
        <div class="prompt-editable-hint">Click to edit before copying</div>
      </div>
    </div>
  </div>
</div>

<script>
// ── Data ──────────────────────────────────────────────────────────────────────

const COMMANDS = {
  review: {
    name: 'review',
    shortDesc: 'Start a local review server',
    description: 'Parse a markdown plan file, start a local review server, and open the plan in your browser for interactive review.',
    positional: { label: 'Session ID or markdown file path', placeholder: './plans/my-plan.md' },
    flags: [
      { key: 'port', flag: '--port', type: 'number', default: 3000, placeholder: '3000', hint: 'Local server port' }
    ],
    expectedOutput: 'Server running at http://localhost:{port}/plan/a1b2c3d4',
    promptTpl: (cmd, pos, flags) => {
      const port = flags.port || 3000;
      const portNote = port !== 3000 ? ` on port ${port}` : '';
      return `Run \`${cmd}\` to start a local review server${portNote} for ${pos || 'the plan file'} and open it in your browser.`;
    }
  },
  status: {
    name: 'status',
    shortDesc: 'Check plan review status',
    description: 'Check the review status of a plan. Exit codes: 0=approved, 3=needs-work, 4=reviewing, 5=no feedback.',
    positional: { label: 'Session ID or markdown file path', placeholder: './plans/my-plan.md' },
    flags: [
      { key: 'pretty', flag: '--pretty', type: 'toggle', default: false, hint: 'Format output as readable JSON' },
      { key: 'wait', flag: '--wait', type: 'toggle', default: false, hint: 'Block until feedback is submitted' },
      { key: 'wait-timeout', flag: '--wait-timeout', type: 'text', default: '', placeholder: '10m', hint: 'Timeout duration (e.g. 10m, 1h, 30s)', enabledWhen: 'wait' }
    ],
    expectedOutput: `{
  "sessionId": "a1b2c3d4",
  "planTitle": "My Plan",
  "status": "reviewing",
  "feedbackStatus": "pending",
  "phaseSummary": { "total": 4, "approved": 1, "needsWork": 1, "pending": 2 },
  "commentSummary": { "total": 7, "unresolved": 3 }
}`,
    promptTpl: (cmd, pos, flags) => {
      const parts = [`Run \`${cmd}\` to check the review status of ${pos || 'the plan'}`];
      if (flags.wait) {
        parts[0] += ', blocking until the reviewer submits feedback';
        if (flags['wait-timeout']) parts[0] += ` with a ${flags['wait-timeout']} timeout`;
      }
      if (flags.pretty) parts[0] += ', and format the output as readable JSON';
      parts[0] += '. Exit code 0 means approved, 3 means needs work, 4 means still reviewing, and 5 means no feedback yet.';
      return parts[0];
    }
  },
  feedback: {
    name: 'feedback',
    shortDesc: 'Read plan feedback JSON',
    description: 'Read the feedback JSON for a reviewed plan. Useful for programmatic access to comments and phase statuses.',
    positional: { label: 'Session ID or markdown file path', placeholder: './plans/my-plan.md' },
    flags: [
      { key: 'phase', flag: '--phase', type: 'text', default: '', placeholder: 'phase-1', hint: 'Filter to a specific phase' },
      { key: 'unresolved', flag: '--unresolved', type: 'toggle', default: false, hint: 'Show only unresolved comments' },
      { key: 'pretty', flag: '--pretty', type: 'toggle', default: false, hint: 'Format output as readable JSON' }
    ],
    expectedOutput: `Full FeedbackPayload JSON with comments array, phaseStatuses, status`,
    promptTpl: (cmd, pos, flags) => {
      let s = `Run \`${cmd}\` to read the feedback for ${pos || 'the plan'}`;
      if (flags.phase) s += `, filtered to phase "${flags.phase}"`;
      if (flags.unresolved) s += ', showing only unresolved comments';
      if (flags.pretty) s += ', formatted as readable JSON';
      s += '. Returns the full feedback payload including comments, phase statuses, and overall status.';
      return s;
    }
  },
  list: {
    name: 'list',
    shortDesc: 'List review sessions',
    description: 'List all plan-assistant sessions found in the given directory tree.',
    positional: null,
    flags: [
      { key: 'dir', flag: '--dir', type: 'text', default: '', placeholder: '.', hint: 'Directory to search (default: current directory)' },
      { key: 'pretty', flag: '--pretty', type: 'toggle', default: false, hint: 'Format output as readable JSON' }
    ],
    expectedOutput: `[
  { "sessionId": "a1b2c3d4", "planTitle": "My Plan", "status": "approved", "updatedAt": "2026-02-23T12:00:00Z" },
  { "sessionId": "e5f6g7h8", "planTitle": "Another Plan", "status": "reviewing", "updatedAt": "2026-02-22T09:30:00Z" }
]`,
    promptTpl: (cmd, pos, flags) => {
      let s = `Run \`${cmd}\` to list all plan-assistant review sessions`;
      if (flags.dir) s += ` in the ${flags.dir} directory`;
      else s += ' in the current directory';
      if (flags.pretty) s += ', formatted as readable JSON';
      s += '. Returns an array of session objects with ID, title, status, and last update timestamp.';
      return s;
    }
  },
  init: {
    name: 'init',
    shortDesc: 'Generate plan template',
    description: 'Generate a markdown plan template with all sections and placeholders.',
    positional: null,
    flags: [
      { key: 'output', flag: '--output', type: 'text', default: '', placeholder: 'my-plan.md', hint: 'Write to file instead of stdout' }
    ],
    expectedOutput: (flags) => flags.output
      ? `Template written to ./${flags.output}`
      : '# Plan Title\n\n## Phase 1: ...\n\n### Task 1.1\n- [ ] ...\n\n(template content written to stdout)',
    promptTpl: (cmd, pos, flags) => {
      let s = `Run \`${cmd}\` to generate a markdown plan template with all sections and placeholders`;
      if (flags.output) s += `, writing it to ${flags.output}`;
      else s += ', printing it to stdout';
      s += '.';
      return s;
    }
  },
  clean: {
    name: 'clean',
    shortDesc: 'Remove old sessions',
    description: 'Remove old or orphaned review sessions. By default, removes sessions whose markdown file no longer exists.',
    positional: null,
    flags: [
      { key: 'all', flag: '--all', type: 'toggle', default: false, hint: 'Remove ALL sessions, not just orphans' },
      { key: 'older-than', flag: '--older-than', type: 'text', default: '', placeholder: '7d', hint: 'Only remove sessions older than this (e.g. 7d, 2w)' },
      { key: 'dry-run', flag: '--dry-run', type: 'toggle', default: false, hint: 'Preview what would be removed without deleting' },
      { key: 'force', flag: '--force', type: 'toggle', default: false, hint: 'Skip confirmation prompt' }
    ],
    expectedOutput: `{
  "removed": 3,
  "sessions": [
    { "sessionId": "a1b2c3d4", "reason": "orphaned" },
    { "sessionId": "e5f6g7h8", "reason": "orphaned" },
    { "sessionId": "i9j0k1l2", "reason": "orphaned" }
  ]
}`,
    promptTpl: (cmd, pos, flags) => {
      let s = `Run \`${cmd}\` to `;
      if (flags['dry-run']) s += 'preview which sessions would be removed';
      else s += 'remove';
      if (flags.all) s += flags['dry-run'] ? ' (all sessions' : ' all sessions';
      else s += flags['dry-run'] ? ' (orphaned sessions' : ' orphaned sessions';
      if (flags['older-than']) s += ` older than ${flags['older-than']}`;
      s += flags['dry-run'] ? ')' : '';
      if (flags.force && !flags['dry-run']) s += ', skipping the confirmation prompt';
      s += '.';
      if (flags['dry-run']) s += ' No sessions will actually be deleted.';
      return s;
    }
  },
  export: {
    name: 'export',
    shortDesc: 'Export plan as HTML',
    description: 'Export a reviewed plan as a self-contained HTML file with all feedback and styling.',
    positional: { label: 'Session ID or markdown file path', placeholder: './plans/my-plan.md' },
    flags: [
      { key: 'output', flag: '--output', type: 'text', default: '', placeholder: 'plan-export.html', hint: 'Write to file instead of stdout' }
    ],
    expectedOutput: (flags) => flags.output
      ? `HTML written to ./${flags.output}`
      : 'Self-contained HTML written to stdout',
    promptTpl: (cmd, pos, flags) => {
      let s = `Run \`${cmd}\` to export ${pos || 'the plan'} as a self-contained HTML file with all feedback and styling`;
      if (flags.output) s += `, writing it to ${flags.output}`;
      else s += ', printing the HTML to stdout';
      s += '.';
      return s;
    }
  }
};

const PRESETS = [
  {
    name: 'Quick Review',
    command: 'review',
    positional: './plan.md',
    flags: { port: 3000 }
  },
  {
    name: 'Wait for Feedback',
    command: 'status',
    positional: './plans/my-plan.md',
    flags: { wait: true, 'wait-timeout': '10m', pretty: true }
  },
  {
    name: 'Unresolved Comments',
    command: 'feedback',
    positional: './plans/my-plan.md',
    flags: { unresolved: true, pretty: true }
  },
  {
    name: 'Dry Run Cleanup',
    command: 'clean',
    positional: '',
    flags: { all: true, 'older-than': '7d', 'dry-run': true }
  },
  {
    name: 'Export Plan',
    command: 'export',
    positional: './plans/my-plan.md',
    flags: { output: 'plan.html' }
  }
];

// ── State ─────────────────────────────────────────────────────────────────────

let activeCommand = 'review';
let positionalValue = '';
let flagValues = {};

// ── Render ────────────────────────────────────────────────────────────────────

function renderPresets() {
  const el = document.getElementById('presets');
  el.innerHTML = PRESETS.map((p, i) =>
    `<button class="preset-btn" onclick="applyPreset(${i})">${p.name}</button>`
  ).join('');
}

function renderCommandGrid() {
  const el = document.getElementById('command-grid');
  el.innerHTML = Object.values(COMMANDS).map(c =>
    `<div class="command-card ${c.name === activeCommand ? 'active' : ''}"
          onclick="selectCommand('${c.name}')">
      <div class="cmd-name">${c.name}</div>
      <div class="cmd-desc">${c.shortDesc}</div>
    </div>`
  ).join('');
}

function renderPositionalInput() {
  const cmd = COMMANDS[activeCommand];
  const section = document.getElementById('positional-section');
  const label = document.getElementById('positional-label');
  const input = document.getElementById('positional-input');

  if (cmd.positional) {
    section.style.display = '';
    label.textContent = cmd.positional.label;
    input.placeholder = cmd.positional.placeholder;
    input.value = positionalValue;
  } else {
    section.style.display = 'none';
  }
}

function renderFlags() {
  const cmd = COMMANDS[activeCommand];
  const container = document.getElementById('flags-section');

  if (!cmd.flags || cmd.flags.length === 0) {
    document.getElementById('flags-container').style.display = 'none';
    return;
  }
  document.getElementById('flags-container').style.display = '';

  container.innerHTML = cmd.flags.map(f => {
    const val = flagValues[f.key] !== undefined ? flagValues[f.key] : f.default;
    const disabled = f.enabledWhen && !flagValues[f.enabledWhen];

    if (f.type === 'toggle') {
      return `<div class="toggle-row">
        <div class="left">
          <span class="flag-label"><code>${f.flag}</code></span>
          <span class="flag-hint">${f.hint}</span>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" ${val ? 'checked' : ''} ${disabled ? 'disabled' : ''}
                 onchange="setFlag('${f.key}', this.checked)">
          <span class="toggle-slider"></span>
        </label>
      </div>`;
    }

    if (f.type === 'number') {
      return `<div class="flag-group">
        <label class="flag-label"><code>${f.flag}</code></label>
        <input type="number" value="${val}" placeholder="${f.placeholder || ''}" ${disabled ? 'disabled' : ''}
               oninput="setFlag('${f.key}', this.value ? Number(this.value) : '')">
        <span class="flag-hint">${f.hint}</span>
      </div>`;
    }

    // text
    return `<div class="flag-group">
      <label class="flag-label"><code>${f.flag}</code></label>
      <input type="text" value="${val}" placeholder="${f.placeholder || ''}" ${disabled ? 'disabled' : ''}
             oninput="setFlag('${f.key}', this.value)">
      <span class="flag-hint">${f.hint}</span>
    </div>`;
  }).join('');
}

function renderPreview() {
  const cmd = COMMANDS[activeCommand];
  const parts = [];

  // Build parts for display
  parts.push({ text: 'plan-assistant', cls: 'tok-bin' });
  parts.push({ text: ' ' });
  parts.push({ text: cmd.name, cls: 'tok-cmd' });

  // Positional arg
  if (cmd.positional && positionalValue) {
    parts.push({ text: ' ' });
    parts.push({ text: positionalValue, cls: 'tok-pos' });
  }

  // Flags
  if (cmd.flags) {
    for (const f of cmd.flags) {
      const val = flagValues[f.key] !== undefined ? flagValues[f.key] : f.default;
      const disabled = f.enabledWhen && !flagValues[f.enabledWhen];
      if (disabled) continue;

      if (f.type === 'toggle') {
        if (!val) continue;
        parts.push({ text: ' ' });
        parts.push({ text: f.flag, cls: 'tok-flag' });
      } else {
        if (val === '' || val === undefined) continue;
        if (f.type === 'number' && val === f.default) continue;
        parts.push({ text: ' ' });
        parts.push({ text: f.flag, cls: 'tok-flag' });
        parts.push({ text: ' ' });
        parts.push({ text: String(val), cls: 'tok-val' });
      }
    }
  }

  // Render syntax-highlighted command
  const previewEl = document.getElementById('command-preview');
  previewEl.innerHTML = parts.map(p =>
    p.cls ? `<span class="${p.cls}">${escHtml(p.text)}</span>` : escHtml(p.text)
  ).join('');

  // Description
  document.getElementById('description-text').textContent = cmd.description;

  // Expected output
  const expectedEl = document.getElementById('expected-output');
  let expectedText = typeof cmd.expectedOutput === 'function'
    ? cmd.expectedOutput(flagValues)
    : cmd.expectedOutput;

  // Replace dynamic port in review output
  if (activeCommand === 'review') {
    const port = flagValues.port || 3000;
    expectedText = expectedText.replace('{port}', port);
  }
  expectedEl.textContent = expectedText;

  // Prompt
  const fullCmd = buildCommandString();
  const promptText = cmd.promptTpl(fullCmd, positionalValue, flagValues) + '\n\n[Playground: CLI Command Builder]';
  const promptEl = document.getElementById('prompt-text');
  promptEl.innerHTML = promptText.replace(/`([^`]+)`/g, '<code>$1</code>');
}

function buildCommandString() {
  const cmd = COMMANDS[activeCommand];
  let s = `plan-assistant ${cmd.name}`;

  if (cmd.positional && positionalValue) {
    s += ` ${positionalValue}`;
  }

  if (cmd.flags) {
    for (const f of cmd.flags) {
      const val = flagValues[f.key] !== undefined ? flagValues[f.key] : f.default;
      const disabled = f.enabledWhen && !flagValues[f.enabledWhen];
      if (disabled) continue;

      if (f.type === 'toggle' && val) {
        s += ` ${f.flag}`;
      } else if (f.type !== 'toggle' && val !== '' && val !== undefined) {
        if (f.type === 'number' && val === f.default) continue;
        s += ` ${f.flag} ${val}`;
      }
    }
  }

  return s;
}

function escHtml(s) {
  return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

// ── Actions ───────────────────────────────────────────────────────────────────

function selectCommand(name) {
  activeCommand = name;
  positionalValue = '';
  flagValues = {};
  // Initialize defaults
  const cmd = COMMANDS[name];
  if (cmd.flags) {
    for (const f of cmd.flags) {
      flagValues[f.key] = f.default;
    }
  }
  renderAll();
}

function setFlag(key, value) {
  flagValues[key] = value;
  // If a parent toggle changes, re-render to enable/disable dependents
  const cmd = COMMANDS[activeCommand];
  const hasDependents = cmd.flags && cmd.flags.some(f => f.enabledWhen === key);
  if (hasDependents) {
    // Clear dependent values if parent is off
    if (!value) {
      for (const f of cmd.flags) {
        if (f.enabledWhen === key) {
          flagValues[f.key] = f.default;
        }
      }
    }
    renderFlags();
  }
  renderPreview();
}

function applyPreset(index) {
  const preset = PRESETS[index];
  activeCommand = preset.command;
  positionalValue = preset.positional || '';
  flagValues = {};
  // Initialize defaults first
  const cmd = COMMANDS[activeCommand];
  if (cmd.flags) {
    for (const f of cmd.flags) {
      flagValues[f.key] = f.default;
    }
  }
  // Apply preset flags on top
  Object.assign(flagValues, preset.flags);
  renderAll();
}

function copyCommand() {
  const text = buildCommandString();
  navigator.clipboard.writeText(text).then(() => {
    const btn = document.getElementById('copy-cmd-btn');
    btn.classList.add('copied');
    btn.innerHTML = `<svg viewBox="0 0 16 16" fill="currentColor"><path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.75.75 0 0 1 1.06-1.06L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"/></svg> Copied!`;
    setTimeout(() => {
      btn.classList.remove('copied');
      btn.innerHTML = `<svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"/></svg> Copy`;
    }, 1500);
  });
}

function copyPrompt() {
  const promptText = document.getElementById('prompt-text').textContent;
  navigator.clipboard.writeText(promptText).then(() => {
    const btn = document.getElementById('copy-prompt-btn');
    btn.classList.add('copied');
    btn.innerHTML = `<svg viewBox="0 0 16 16" fill="currentColor"><path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.75.75 0 0 1 1.06-1.06L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"/></svg> Copied!`;
    setTimeout(() => {
      btn.classList.remove('copied');
      btn.innerHTML = `<svg viewBox="0 0 16 16" fill="currentColor"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"/><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"/></svg> Copy`;
    }, 1500);
  });
}

// ── Positional Input Listener ─────────────────────────────────────────────────

document.getElementById('positional-input').addEventListener('input', function() {
  positionalValue = this.value;
  renderPreview();
});

// ── Init ──────────────────────────────────────────────────────────────────────

function renderAll() {
  renderPresets();
  renderCommandGrid();
  renderPositionalInput();
  renderFlags();
  renderPreview();
}

// Start with review command defaults
selectCommand('review');
</script>

</body>
</html>
